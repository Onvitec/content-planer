<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onvitec Content Planer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 4px; }
        .calendar-day { min-height: 120px; }
        .modal-backdrop, .lightbox-backdrop, .confirmation-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content, .confirmation-content, .lightbox-content { transition: transform 0.3s ease-in-out; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-entwurf { background-color: #e5e7eb; color: #4b5563; }
        .status-freigabe { background-color: #fef08a; color: #854d0e; }
        .status-geplant { background-color: #bbf7d0; color: #166534; }
        .status-veroeffentlicht { background-color: #d8b4fe; color: #581c87; }
        .task-item input[type="checkbox"]:checked + span { text-decoration: line-through; color: #9ca3af; }
        .kanban-column { min-height: 400px; }
        .kanban-card.dragging, .idea-card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .kanban-column.drag-over, .calendar-day.drag-over, .idea-folder-content.drag-over { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 antialiased">

    <!-- Authentifizierungs-Ansicht -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div>
                <h2 id="auth-title" class="text-center text-3xl font-bold text-gray-900">Anmelden</h2>
                <p id="auth-subtitle" class="mt-2 text-center text-sm text-gray-600">
                    oder <button id="switch-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">erstelle einen neuen Account</button>
                </p>
            </div>
            <form id="auth-form" class="mt-8 space-y-6">
                <div id="name-fields" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label for="first-name" class="sr-only">Vorname</label>
                        <input id="first-name" name="firstName" type="text" autocomplete="given-name" class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Vorname">
                    </div>
                    <div>
                        <label for="last-name" class="sr-only">Nachname</label>
                        <input id="last-name" name="lastName" type="text" autocomplete="family-name" class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Nachname">
                    </div>
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">E-Mail Adresse</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="E-Mail Adresse">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Passwort</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Passwort">
                    </div>
                </div>
                <p id="auth-error" class="text-sm text-red-600"></p>
                <div>
                    <button type="submit" id="auth-submit-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Anmelden
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hauptanwendung (initial versteckt) -->
    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        <header class="flex justify-between items-center mb-8">
            <div class="text-left">
                <h1 class="text-4xl font-bold text-gray-900">Onvitec Content Planer</h1>
                <p id="user-greeting" class="text-gray-600 mt-2"></p>
            </div>
            <div class="flex items-center gap-4">
                <button id="profile-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md">Profil</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Abmelden</button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="lg:w-1/3 xl:w-1/4">
                <div class="bg-white p-4 rounded-2xl shadow-md h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Ideen-Backlog</h2>
                        <button id="add-folder-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Neuen Ordner erstellen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H2V6z" clip-rule="evenodd" /><path d="M2 12a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2z" /></svg>
                        </button>
                    </div>
                    <div id="idea-bank-container" class="space-y-4 overflow-y-auto" style="max-height: 70vh;">
                    </div>
                </div>
            </aside>

            <div class="flex-1">
                <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-2xl shadow-md">
                    <div id="monthControl" class="flex items-center">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                        <h2 id="currentMonthYear" class="text-2xl font-semibold w-48 text-center"></h2>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                    <div id="viewSwitcher" class="flex items-center gap-2 rounded-full bg-gray-200 p-1">
                        <button data-view="dashboard" class="view-btn p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></button>
                        <button data-view="calendar" class="view-btn p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg></button>
                        <button data-view="board" class="view-btn p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4zM8 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1H9a1 1 0 01-1-1V4zM15 3a1 1 0 00-1 1v12a1 1 0 001 1h2a1 1 0 001-1V4a1 1 0 00-1-1h-2z" /></svg></button>
                    </div>
                </div>

                <main id="mainViewContainer">
                     <div id="dashboardView" class="hidden"></div>
                     <div id="calendarView" class="bg-white p-2 sm:p-4 rounded-2xl shadow-lg"><div class="calendar-grid mb-2"><div class="text-center font-semibold text-gray-600 py-2">Mo</div><div class="text-center font-semibold text-gray-600 py-2">Di</div><div class="text-center font-semibold text-gray-600 py-2">Mi</div><div class="text-center font-semibold text-gray-600 py-2">Do</div><div class="text-center font-semibold text-gray-600 py-2">Fr</div><div class="text-center font-semibold text-gray-600 py-2">Sa</div><div class="text-center font-semibold text-gray-600 py-2">So</div></div><div id="calendarGrid" class="calendar-grid"></div></div>
                     <div id="boardView" class="hidden">
                         <div id="board-filter-container" class="flex items-center gap-2 mb-4 bg-white p-3 rounded-2xl shadow-md">
                             <span class="font-semibold text-gray-700">Aufgaben von:</span>
                         </div>
                         <div id="board-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                     </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="postModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none modal-backdrop"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content transform scale-95"><div class="flex items-center justify-between p-6 border-b"><h3 class="text-2xl font-bold">Post Details</h3><button id="closeModalBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="flex-1 p-6 overflow-y-auto space-y-4"><input type="hidden" id="postId"><input type="hidden" id="postDate"><input type="hidden" id="postFolderId"><div><label for="postTitle" class="block text-sm font-medium text-gray-700 mb-1">Titel</label><input type="text" id="postTitle" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Kurzer Titel für die Kalenderansicht"></div><div><label for="postStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label><select id="postStatus" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"><option value="entwurf">Entwurf</option><option value="freigabe">Zur Freigabe</option><option value="geplant">Geplant</option><option value="veroeffentlicht">Veröffentlicht</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Aufgaben-Checkliste</label><div id="taskListContainer" class="space-y-2 mb-3"></div><div class="flex gap-2"><input type="text" id="newTaskInput" placeholder="Neue Aufgabe hinzufügen..." class="flex-grow w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"><button id="addTaskBtn" class="bg-blue-100 text-blue-800 font-semibold px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors">Add</button></div></div><div><label for="postCaption" class="block text-sm font-medium text-gray-700 mb-1">Caption</label><textarea id="postCaption" rows="6" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Schreibe hier deinen Post-Text..."></textarea></div><div><label for="postHashtags" class="block text-sm font-medium text-gray-700 mb-1">Hashtags</label><input type="text" id="postHashtags" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="#planning #socialmedia ..."></div></div><div class="p-6 border-t"><h4 class="text-lg font-semibold mb-2">Kommentare</h4><div id="comments-container" class="space-y-4 max-h-48 overflow-y-auto mb-4"></div><div class="relative flex items-start gap-3"><div class="flex-1"><textarea id="new-comment-input" placeholder="Schreibe einen Kommentar... @ um jemanden zu erwähnen" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 pr-12"></textarea><button id="send-comment-btn" class="absolute right-2 bottom-2 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 disabled:opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button><div id="mention-suggestions" class="hidden absolute bottom-full left-0 w-full bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto"></div></div></div></div><div class="flex items-center justify-between p-6 border-t bg-gray-50 rounded-b-2xl"><div class="flex gap-2"><button id="exportPdfBtn" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">Export als PDF</button><button id="deletePostBtn" class="text-red-600 hover:text-red-800 font-semibold transition-colors">Post löschen</button></div><div class="flex items-center"><p id="modal-error" class="text-sm text-red-500 mr-4"></p><button id="cancelModalBtn" class="bg-white py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Abbrechen</button><button id="savePostBtn" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">Speichern</button></div></div></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none transition-opacity duration-300 confirmation-backdrop"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform scale-95 transition-transform duration-300 confirmation-content"><h4 id="confirmationTitle" class="text-lg font-bold mb-2">Aktion bestätigen</h4><p id="confirmationMessage" class="text-gray-600 mb-6">Möchtest du wirklich fortfahren?</p><div class="flex justify-center gap-4"><button id="confirmCancelBtn" class="bg-white py-2 px-6 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">Abbrechen</button><button id="confirmActionBtn" class="py-2 px-6 border border-transparent rounded-lg font-medium text-white">Bestätigen</button></div></div></div>
    <div id="folderModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none transition-opacity duration-300 confirmation-backdrop"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-300 confirmation-content"><h4 id="folderModalTitle" class="text-lg font-bold mb-4">Ordner verwalten</h4><input type="hidden" id="folderId"><div><label for="folderName" class="sr-only">Ordnername</label><input id="folderName" type="text" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Name des Ordners"></div><div class="flex justify-end gap-4 mt-6"><button id="folderCancelBtn" class="bg-white py-2 px-6 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">Abbrechen</button><button id="folderSaveBtn" class="py-2 px-6 border border-transparent rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700">Speichern</button></div></div></div>
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none transition-opacity duration-300 confirmation-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-300 confirmation-content">
            <h4 class="text-lg font-bold mb-4">Profil bearbeiten</h4>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="profileFirstName" class="block text-sm font-medium text-gray-700">Vorname</label>
                        <input id="profileFirstName" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="profileLastName" class="block text-sm font-medium text-gray-700">Nachname</label>
                        <input id="profileLastName" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="profileEmail" class="block text-sm font-medium text-gray-700">E-Mail</label>
                    <input id="profileEmail" type="email" disabled class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-500">
                </div>
                <div>
                    <button id="changePasswordBtn" class="text-sm font-medium text-blue-600 hover:text-blue-500">Passwort ändern...</button>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="profileCancelBtn" class="bg-white py-2 px-6 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">Abbrechen</button>
                <button id="profileSaveBtn" class="py-2 px-6 border border-transparent rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, getDoc, serverTimestamp, writeBatch, orderBy, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiCG2qt3N6-Dw8Py3zXAD-4wOML56sccM",
            authDomain: "onvitec-content-planer.firebaseapp.com",
            projectId: "onvitec-content-planer",
            storageBucket: "onvitec-content-planer.appspot.com",
            messagingSenderId: "273056072477",
            appId: "1:273056072477:web:56e9d5856a50144c2a97f4",
            measurementId: "G-R71BDC8F11"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- STATE & DOM ---
        let currentDate = new Date();
        let localPosts = [];
        let localFolders = [];
        let allUsers = [];
        let currentUserProfile = null;
        let localNewComments = []; // Holds comments for a new post before it's saved
        let unsubscribePosts = null; 
        let unsubscribeFolders = null;
        let unsubscribeUsers = null;
        let unsubscribeComments = null;
        let initialPostState = null;
        let confirmAction = null;
        let currentView = 'dashboard'; // Default to dashboard
        let authMode = 'login';
        let currentBoardFilter = 'all';

        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('app');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const userGreetingEl = document.getElementById('user-greeting');
        const nameFields = document.getElementById('name-fields');
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const modal = document.getElementById('postModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const savePostBtn = document.getElementById('savePostBtn');
        const deletePostBtn = document.getElementById('deletePostBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const taskListContainer = document.getElementById('taskListContainer');
        const newTaskInput = document.getElementById('newTaskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const monthControl = document.getElementById('monthControl');
        const viewSwitcher = document.getElementById('viewSwitcher');
        const dashboardView = document.getElementById('dashboardView');
        const calendarView = document.getElementById('calendarView');
        const boardView = document.getElementById('boardView');
        const boardFilterContainer = document.getElementById('board-filter-container');
        const boardGrid = document.getElementById('board-grid');
        const modalError = document.getElementById('modal-error');
        const ideaBankContainer = document.getElementById('idea-bank-container');
        const addFolderBtn = document.getElementById('add-folder-btn');
        const folderModal = document.getElementById('folderModal');
        const folderModalTitle = document.getElementById('folderModalTitle');
        const folderIdInput = document.getElementById('folderId');
        const folderNameInput = document.getElementById('folderName');
        const folderCancelBtn = document.getElementById('folderCancelBtn');
        const folderSaveBtn = document.getElementById('folderSaveBtn');
        const profileModal = document.getElementById('profileModal');
        const profileFirstNameInput = document.getElementById('profileFirstName');
        const profileLastNameInput = document.getElementById('profileLastName');
        const profileEmailInput = document.getElementById('profileEmail');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const profileCancelBtn = document.getElementById('profileCancelBtn');
        const profileSaveBtn = document.getElementById('profileSaveBtn');
        const commentsContainer = document.getElementById('comments-container');
        const newCommentInput = document.getElementById('new-comment-input');
        const sendCommentBtn = document.getElementById('send-comment-btn');
        const mentionSuggestions = document.getElementById('mention-suggestions');
        const boardColumns = [{ id: 'entwurf', title: 'Entwurf' }, { id: 'freigabe', title: 'Zur Freigabe' }, { id: 'geplant', title: 'Geplant' }, { id: 'veroeffentlicht', title: 'Veröffentlicht' }];

        // --- HELPER FUNCTIONS ---
        const getTasksFromDOM = () => Array.from(taskListContainer.querySelectorAll('.task-item')).map(item => ({ id: item.dataset.taskId, text: item.querySelector('.task-text').value, completed: item.querySelector('.task-checkbox').checked, assignedTo: item.querySelector('.task-assignee').value }));
        
        const getFullFormState = () => {
            return {
                title: document.getElementById('postTitle').value,
                caption: document.getElementById('postCaption').value,
                hashtags: document.getElementById('postHashtags').value,
                status: document.getElementById('postStatus').value,
                tasks: getTasksFromDOM()
            };
        };

        const hasUnsavedChanges = () => initialPostState && JSON.stringify(initialPostState) !== JSON.stringify(getFullFormState());
        
        // --- AUTHENTICATION ---
        const updateAuthUI = () => {
            nameFields.classList.toggle('hidden', authMode !== 'register');
            if (authMode === 'login') {
                authTitle.textContent = 'Anmelden';
                authSubmitBtn.textContent = 'Anmelden';
                authSubtitle.innerHTML = `oder <button id="switch-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">erstelle einen neuen Account</button>`;
            } else {
                authTitle.textContent = 'Registrieren';
                authSubmitBtn.textContent = 'Account erstellen';
                authSubtitle.innerHTML = `Du hast bereits einen Account? <button id="switch-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">Hier anmelden</button>`;
            }
            document.getElementById('switch-auth-mode').addEventListener('click', () => {
                authMode = authMode === 'login' ? 'register' : 'login';
                updateAuthUI();
            });
        };

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';

            if (authMode === 'register') {
                const firstName = authForm.firstName.value;
                const lastName = authForm.lastName.value;
                if (!firstName || !lastName) {
                    authError.textContent = "Bitte Vor- und Nachname angeben.";
                    return;
                }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        firstName: firstName,
                        lastName: lastName,
                        email: user.email
                    });
                } catch (error) {
                    authError.textContent = error.message;
                }
            } else {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => authError.textContent = error.message);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserProfile = { id: user.uid, ...userDoc.data() };
                    userGreetingEl.textContent = `Hallo, ${currentUserProfile.firstName}!`;
                } else {
                    userGreetingEl.textContent = `Hallo!`;
                }

                const postsColRef = collection(db, 'posts');
                unsubscribePosts = onSnapshot(query(postsColRef), (snapshot) => {
                    localPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                });

                const foldersColRef = collection(db, 'folders');
                unsubscribeFolders = onSnapshot(query(foldersColRef), (snapshot) => {
                    localFolders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderIdeaBank();
                });

                const usersColRef = collection(db, 'users');
                unsubscribeUsers = onSnapshot(query(usersColRef), (snapshot) => {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });


            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                userGreetingEl.textContent = '';
                if (unsubscribePosts) unsubscribePosts();
                if (unsubscribeFolders) unsubscribeFolders();
                if (unsubscribeUsers) unsubscribeUsers();
                localPosts = [];
                localFolders = [];
                allUsers = [];
                currentUserProfile = null;
            }
        });
        
        // --- DATA (FIRESTORE) ---
        const deletePost = async (postId) => {
            const user = auth.currentUser;
            if (!user || !postId) return;
            await deleteDoc(doc(db, 'posts', postId));
        };

        const updatePost = async (postId, data) => {
            const user = auth.currentUser;
            if (!user || !postId) return;
            await setDoc(doc(db, 'posts', postId), data, { merge: true });
        };

        const createFolder = async (name) => {
            const user = auth.currentUser;
            if (!user || !name) return;
            await addDoc(collection(db, 'folders'), {
                name: name,
                createdAt: serverTimestamp()
            });
        };

        const updateFolder = async (folderId, newName) => {
            const user = auth.currentUser;
            if (!user || !folderId || !newName) return;
            await setDoc(doc(db, 'folders', folderId), { name: newName }, { merge: true });
        };

        const deleteFolder = async (folderId) => {
            const user = auth.currentUser;
            if (!user || !folderId) return;

            const batch = writeBatch(db);
            const postsToMove = localPosts.filter(p => p.folderId === folderId);
            postsToMove.forEach(post => {
                const postRef = doc(db, 'posts', post.id);
                batch.update(postRef, { folderId: 'unassigned' });
            });
            await batch.commit();

            await deleteDoc(doc(db, 'folders', folderId));
        };
        
        const saveComment = async (postId, commentData) => {
            const user = auth.currentUser;
            if (!user || !postId) return;
            const commentsColRef = collection(db, 'posts', postId, 'comments');
            await addDoc(commentsColRef, {
                ...commentData,
                createdAt: serverTimestamp()
            });
        };

        // --- MODALS ---
        const openConfirmationModal = (config) => {
            confirmationTitle.textContent = config.title;
            confirmationMessage.textContent = config.message;
            confirmActionBtn.textContent = config.confirmText;
            confirmActionBtn.className = `py-2 px-6 border border-transparent rounded-lg font-medium text-white ${config.confirmClass}`;
            confirmAction = config.onConfirm;
            confirmationModal.classList.remove('opacity-0', 'pointer-events-none');
            confirmationModal.querySelector('.confirmation-content').classList.remove('scale-95');
        };
        const closeConfirmationModal = () => {
            confirmationModal.classList.add('opacity-0', 'pointer-events-none');
            confirmationModal.querySelector('.confirmation-content').classList.add('scale-95');
            confirmAction = null;
        };
        const openModal = () => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            setTimeout(() => initialPostState = getFullFormState(), 200); 
        };
        const closeModal = () => {
            if (unsubscribeComments) unsubscribeComments();
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
            resetModalForm();
        };
        const resetModalForm = () => {
            document.getElementById('postId').value = '';
            document.getElementById('postDate').value = '';
            document.getElementById('postFolderId').value = '';
            document.getElementById('postTitle').value = '';
            document.getElementById('postCaption').value = '';
            document.getElementById('postHashtags').value = '';
            document.getElementById('postStatus').value = 'entwurf';
            taskListContainer.innerHTML = '';
            commentsContainer.innerHTML = '';
            initialPostState = null;
            localNewComments = []; // Reset local comments
            modalError.textContent = '';
            savePostBtn.disabled = false;
            savePostBtn.innerHTML = 'Speichern';
        };
        const fillModalForm = (post) => {
            resetModalForm();
            document.getElementById('postId').value = post.id;
            document.getElementById('postDate').value = post.date || '';
            document.getElementById('postFolderId').value = post.folderId || '';
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postCaption').value = post.caption;
            document.getElementById('postHashtags').value = post.hashtags;
            document.getElementById('postStatus').value = post.status;
            
            renderTasks(post.tasks || []);

            const user = auth.currentUser;
            if (user && post.id) {
                const commentsColRef = collection(db, 'posts', post.id, 'comments');
                unsubscribeComments = onSnapshot(query(commentsColRef, orderBy("createdAt", "asc")), (snapshot) => {
                    const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderComments(comments);
                });
            }
        };
        
        const openFolderModal = (folderId = null, currentName = '') => {
            folderIdInput.value = folderId || '';
            folderNameInput.value = currentName;
            folderModalTitle.textContent = folderId ? 'Ordner umbenennen' : 'Neuen Ordner erstellen';
            folderModal.classList.remove('opacity-0', 'pointer-events-none');
            folderModal.querySelector('.confirmation-content').classList.remove('scale-95');
        };
        const closeFolderModal = () => {
            folderModal.classList.add('opacity-0', 'pointer-events-none');
            folderModal.querySelector('.confirmation-content').classList.add('scale-95');
        };
        
        const openProfileModal = async () => {
            profileSaveBtn.disabled = false;
            profileSaveBtn.innerHTML = 'Speichern';
            const user = auth.currentUser;
            if (!user) return;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                profileFirstNameInput.value = data.firstName || '';
                profileLastNameInput.value = data.lastName || '';
                profileEmailInput.value = data.email || '';
            }
            profileModal.classList.remove('opacity-0', 'pointer-events-none');
            profileModal.querySelector('.confirmation-content').classList.remove('scale-95');
        };
        const closeProfileModal = () => {
            profileModal.classList.add('opacity-0', 'pointer-events-none');
            profileModal.querySelector('.confirmation-content').classList.add('scale-95');
        };
        
        // --- TASKS & COMMENTS ---
        const renderTasks = (tasks = []) => {
            taskListContainer.innerHTML = '';
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item flex items-center gap-2 bg-gray-50 p-2 rounded-lg';
                taskItem.dataset.taskId = task.id;
                
                const userOptions = allUsers.map(user => `<option value="${user.id}" ${task.assignedTo === user.id ? 'selected' : ''}>${user.firstName}</option>`).join('');
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${task.completed ? 'checked' : ''}>
                    <input type="text" class="task-text flex-grow bg-transparent border-none focus:ring-0 p-0" value="${task.text}">
                    <select class="task-assignee w-24 text-xs bg-gray-200 border-none rounded-full px-2 py-1 text-center focus:ring-1 focus:ring-blue-500">
                        <option value="">Wer?</option>
                        ${userOptions}
                    </select>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                `;
                taskListContainer.appendChild(taskItem);
            });
        };
        const addTask = (text) => {
            const tasks = getTasksFromDOM();
            tasks.push({ id: `task-${Date.now()}`, text: text, completed: false, assignedTo: '' });
            renderTasks(tasks);
        };

        const renderComments = (comments) => {
            commentsContainer.innerHTML = '';
            comments.forEach(comment => {
                const author = allUsers.find(u => u.id === comment.authorId);
                const commentEl = document.createElement('div');
                commentEl.className = 'flex items-start gap-3';
                const authorName = author ? author.firstName : 'Unbekannt';

                let commentText = comment.text;
                
                if (comment.mentions) {
                    comment.mentions.forEach(mention => {
                        const mentionedUser = allUsers.find(u => u.id === mention.uid);
                        if (mentionedUser) {
                            const mentionTag = `@${mentionedUser.firstName}`;
                            if (mention.read) {
                                commentText = commentText.replace(mentionTag, `${mentionTag} <span class="text-green-500" title="Gelesen von ${mentionedUser.firstName}">&#10003;</span>`);
                            }
                        }
                    });
                }
                
                const date = comment.createdAt?.toDate ? comment.createdAt.toDate() : comment.createdAt;
                const dateString = date ? date.toLocaleString('de-DE') : '';

                commentEl.innerHTML = `
                    <div class="flex-1 bg-gray-50 p-3 rounded-lg">
                        <p class="font-semibold text-sm">${authorName} <span class="text-gray-500 font-normal text-xs">${dateString}</span></p>
                        <p class="text-gray-700 mt-1">${commentText}</p>
                    </div>
                `;
                commentsContainer.appendChild(commentEl);
            });
            commentsContainer.scrollTop = commentsContainer.scrollHeight;
        };

        // --- RENDER LOGIC ---
        const render = () => {
            if (currentView === 'dashboard') {
                renderDashboard();
            } else if (currentView === 'calendar') {
                renderCalendar();
            } else {
                renderBoard();
            }
            renderIdeaBank();
            updateViewSwitcher();
        };
        
        const renderIdeaBank = () => {
            ideaBankContainer.innerHTML = '';
            const folderColors = ['bg-red-100', 'bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-purple-100', 'bg-pink-100'];
            const folders = [...localFolders, {id: 'unassigned', name: 'Unsortiert'}];

            folders.forEach((folder, index) => {
                const folderEl = document.createElement('details');
                folderEl.className = 'bg-gray-50 rounded-lg open:shadow-lg';
                folderEl.open = true;

                const ideasInFolder = localPosts.filter(p => !p.date && (p.folderId === folder.id || (folder.id === 'unassigned' && !p.folderId)));
                
                const colorClass = folder.id !== 'unassigned' ? folderColors[index % folderColors.length] : 'bg-gray-100';

                const folderControls = folder.id !== 'unassigned' ? `
                    <div class="flex items-center">
                        <button data-folder-id="${folder.id}" data-folder-name="${folder.name}" class="edit-folder-btn p-1 rounded-full hover:bg-gray-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button data-folder-id="${folder.id}" class="delete-folder-btn p-1 rounded-full hover:bg-gray-300 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <button data-folder-id="${folder.id}" class="add-idea-btn p-1 rounded-full hover:bg-gray-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                ` : `
                    <button data-folder-id="${folder.id}" class="add-idea-btn p-1 rounded-full hover:bg-gray-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                `;

                folderEl.innerHTML = `
                    <summary class="p-3 cursor-pointer flex justify-between items-center font-semibold ${colorClass} rounded-t-lg">
                        <span class="flex-1 truncate">${folder.name} (${ideasInFolder.length})</span>
                        ${folderControls}
                    </summary>
                    <div class="idea-folder-content p-3 border-t border-gray-200 space-y-2" data-folder-id="${folder.id}">
                        <!-- Ideen hier -->
                    </div>
                `;

                const ideasContainer = folderEl.querySelector('.idea-folder-content');
                ideasContainer.addEventListener('dragover', (e) => { e.preventDefault(); ideasContainer.classList.add('drag-over'); });
                ideasContainer.addEventListener('dragleave', () => ideasContainer.classList.remove('drag-over'));
                ideasContainer.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    ideasContainer.classList.remove('drag-over');
                    const postId = e.dataTransfer.getData('text/plain');
                    const folderId = ideasContainer.dataset.folderId;
                    await updatePost(postId, { date: null, folderId: folderId });
                });


                ideasInFolder.forEach(idea => {
                    const ideaCard = document.createElement('div');
                    ideaCard.className = `idea-card p-2 rounded-md shadow-sm cursor-grab bg-white`;
                    
                    ideaCard.dataset.postId = idea.id;
                    ideaCard.draggable = true;
                    ideaCard.innerHTML = `<p class="text-sm font-medium">${idea.title || 'Ohne Titel'}</p>`;
                    
                    ideaCard.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', idea.id);
                        setTimeout(() => ideaCard.classList.add('dragging'), 0);
                    });
                    ideaCard.addEventListener('dragend', () => ideaCard.classList.remove('dragging'));
                    
                    ideaCard.addEventListener('click', () => { fillModalForm(idea); openModal(); });

                    ideasContainer.appendChild(ideaCard);
                });

                ideaBankContainer.appendChild(folderEl);
            });
        };

        const renderCalendar = () => {
            const scheduledPosts = localPosts.filter(p => p.date);
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${currentDate.toLocaleString('de-DE', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = (firstDayOfMonth + 6) % 7;
            for (let i = 0; i < startDay; i++) { calendarGrid.innerHTML += `<div class="border border-gray-200 rounded-lg"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayPosts = scheduledPosts.filter(p => p.date === dateStr);
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border border-gray-200 rounded-lg p-2 flex flex-col transition-colors';
                dayCell.dataset.date = dateStr;
                dayCell.innerHTML = `<span class="font-semibold text-gray-700">${day}</span>`;

                dayCell.addEventListener('dragover', (e) => { e.preventDefault(); dayCell.classList.add('drag-over'); });
                dayCell.addEventListener('dragleave', () => dayCell.classList.remove('drag-over'));
                dayCell.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dayCell.classList.remove('drag-over');
                    const postId = e.dataTransfer.getData('text/plain');
                    const newDate = dayCell.dataset.date;
                    await updatePost(postId, { date: newDate, folderId: null });
                });

                const postsContainer = document.createElement('div');
                postsContainer.className = 'mt-1 space-y-1 overflow-y-auto';
                dayPosts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = `p-1.5 rounded-md text-xs font-semibold cursor-pointer bg-gray-100`;

                    postCard.dataset.postId = post.id;
                    postCard.draggable = true;
                    postCard.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', post.id);
                        setTimeout(() => postCard.classList.add('dragging'), 0);
                    });
                    postCard.addEventListener('dragend', () => postCard.classList.remove('dragging'));

                    const tasksTotal = post.tasks?.length || 0;
                    const tasksCompleted = post.tasks?.filter(t => t.completed).length || 0;
                    postCard.innerHTML = `<div class="flex items-center gap-2"><span class="truncate flex-1">${post.title || 'Ohne Titel'}</span>${tasksTotal > 0 ? `<span class="text-gray-500 text-[10px]">${tasksCompleted}/${tasksTotal}</span>` : ''}<span class="status-badge status-${post.status}">${post.status.charAt(0)}</span></div>`;
                    postCard.addEventListener('click', (e) => { e.stopPropagation(); fillModalForm(post); openModal(); });
                    postsContainer.appendChild(postCard);
                });
                dayCell.appendChild(postsContainer);
                dayCell.addEventListener('click', () => { resetModalForm(); document.getElementById('postDate').value = dateStr; openModal(); });
                calendarGrid.appendChild(dayCell);
            }
        };

        const renderBoard = () => {
            let filteredPosts = localPosts; // Use all posts, not just scheduled
            if (currentBoardFilter !== 'all') {
                filteredPosts = localPosts.filter(post => 
                    post.tasks && post.tasks.some(task => task.assignedTo === currentBoardFilter)
                );
            }

            boardGrid.innerHTML = '';
            boardColumns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'bg-white p-3 rounded-2xl shadow-md';
                columnEl.innerHTML = `<h3 class="font-bold text-lg mb-3">${column.title}</h3><div class="kanban-column space-y-3" data-status="${column.id}"></div>`;
                const postsInColumn = filteredPosts.filter(p => p.status === column.id);
                const cardsContainer = columnEl.querySelector('.kanban-column');
                postsInColumn.forEach(post => {
                    const card = document.createElement('div');
                    card.className = `kanban-card p-3 rounded-lg shadow-sm cursor-pointer bg-gray-50`;

                    card.draggable = true;
                    card.dataset.postId = post.id;
                    const tasksTotal = post.tasks?.length || 0;
                    const tasksCompleted = post.tasks?.filter(t => t.completed).length || 0;
                    const dateDisplay = post.date ? new Date(post.date).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'}) : 'Kein Datum';
                    card.innerHTML = `<p class="font-semibold mb-2">${post.title || 'Ohne Titel'}</p><div class="flex items-center justify-between text-xs text-gray-500"><span>${dateDisplay}</span>${tasksTotal > 0 ? `<span>${tasksCompleted}/${tasksTotal} Tasks</span>` : '<span></span>'}</div>`;
                    card.addEventListener('click', () => { fillModalForm(post); openModal(); });
                    card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', post.id); setTimeout(() => card.classList.add('dragging'), 0); });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                    cardsContainer.appendChild(card);
                });
                cardsContainer.addEventListener('dragover', (e) => { e.preventDefault(); cardsContainer.classList.add('drag-over'); });
                cardsContainer.addEventListener('dragleave', () => cardsContainer.classList.remove('drag-over'));
                cardsContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cardsContainer.classList.remove('drag-over');
                    const postId = e.dataTransfer.getData('text/plain');
                    updatePost(postId, { status: column.id });
                });
                boardGrid.appendChild(columnEl);
            });
            updateBoardFilterUI();
        };

        const renderDashboard = async () => {
            if (!currentUserProfile) return;
            dashboardView.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Meine Aufgaben</h2>
                        <div id="dashboard-tasks" class="space-y-3"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Meine Erwähnungen</h2>
                        <div id="dashboard-mentions" class="space-y-3"></div>
                    </div>
                </div>
            `;

            const tasksContainer = document.getElementById('dashboard-tasks');
            const mentionsContainer = document.getElementById('dashboard-mentions');
            const currentUserId = currentUserProfile.id;

            // --- Render Tasks ---
            tasksContainer.innerHTML = '';
            let hasTasks = false;
            localPosts.forEach(post => {
                if (post.tasks) {
                    post.tasks.forEach(task => {
                        if (task.assignedTo === currentUserId && !task.completed) {
                            hasTasks = true;
                            const taskEl = document.createElement('div');
                            taskEl.className = 'p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100';
                            taskEl.dataset.postId = post.id;
                            taskEl.innerHTML = `
                                <p class="font-semibold">${task.text}</p>
                                <p class="text-sm text-gray-500">In Post: ${post.title || 'Ohne Titel'}</p>
                            `;
                            taskEl.addEventListener('click', () => {
                                const fullPost = localPosts.find(p => p.id === post.id);
                                if (fullPost) {
                                    fillModalForm(fullPost);
                                    openModal();
                                }
                            });
                            tasksContainer.appendChild(taskEl);
                        }
                    });
                }
            });
            if (!hasTasks) {
                tasksContainer.innerHTML = '<p class="text-gray-500">Keine offenen Aufgaben zugewiesen.</p>';
            }

            // --- Render Mentions ---
            mentionsContainer.innerHTML = '<p class="text-gray-500">Suche nach Erwähnungen...</p>';
            const mentionPromises = localPosts.map(async (post) => {
                const commentsColRef = collection(db, 'posts', post.id, 'comments');
                const snapshot = await getDocs(commentsColRef);
                return { post, comments: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
            });

            const allCommentsByPost = await Promise.all(mentionPromises);
            const allMentions = [];
            allCommentsByPost.forEach(({ post, comments }) => {
                comments.forEach(comment => {
                    if (comment.mentions) {
                        const userMention = comment.mentions.find(m => m.uid === currentUserId && !m.read);
                        if (userMention) {
                            allMentions.push({ post, comment });
                        }
                    }
                });
            });
            
            mentionsContainer.innerHTML = '';
            if (allMentions.length > 0) {
                allMentions.forEach(({ post, comment }) => {
                    const mentionEl = document.createElement('div');
                    mentionEl.className = 'p-3 bg-gray-50 rounded-lg';
                    const author = allUsers.find(u => u.id === comment.authorId);
                    const authorName = author ? author.firstName : 'Jemand';
                    mentionEl.innerHTML = `
                        <div class="cursor-pointer" data-post-id="${post.id}">
                            <p class="text-sm text-gray-700 break-words"><strong>${authorName}</strong> erwähnte Sie in <em>"${post.title || 'Ohne Titel'}"</em></p>
                            <p class="text-sm text-gray-500 mt-1 p-2 bg-white rounded"><em>"${comment.text.replace(/@(\w+)/g, '<strong class="text-blue-600">@$1</strong>')}"</em></p>
                        </div>
                        <button class="mark-mention-as-read-btn text-xs font-semibold text-blue-600 hover:text-blue-800 mt-2" data-post-id="${post.id}" data-comment-id="${comment.id}">Als gelesen markieren</button>
                    `;
                    mentionEl.querySelector('.cursor-pointer').addEventListener('click', () => {
                        const fullPost = localPosts.find(p => p.id === post.id);
                        if (fullPost) {
                            fillModalForm(fullPost);
                            openModal();
                        }
                    });
                    mentionsContainer.appendChild(mentionEl);
                });
            } else {
                mentionsContainer.innerHTML = '<p class="text-gray-500">Keine neuen Erwähnungen.</p>';
            }
        };


        const updateViewSwitcher = () => {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('bg-white', btn.dataset.view === currentView);
                btn.classList.toggle('text-blue-600', btn.dataset.view === currentView);
                btn.classList.toggle('text-gray-600', btn.dataset.view !== currentView);
            });
            dashboardView.classList.toggle('hidden', currentView !== 'dashboard');
            calendarView.classList.toggle('hidden', currentView !== 'calendar');
            boardView.classList.toggle('hidden', currentView !== 'board');
            monthControl.style.visibility = currentView === 'calendar' ? 'visible' : 'hidden';
        };
        
        const updateBoardFilterUI = () => {
             boardFilterContainer.innerHTML = `<span class="font-semibold text-gray-700">Aufgaben von:</span>`;
             const allBtn = document.createElement('button');
             allBtn.dataset.filter = 'all';
             allBtn.textContent = 'Alle';
             allBtn.className = `board-filter-btn px-3 py-1 rounded-full text-sm font-semibold transition-colors`;
             boardFilterContainer.appendChild(allBtn);

             allUsers.forEach(user => {
                 const memberBtn = document.createElement('button');
                 memberBtn.dataset.filter = user.id;
                 memberBtn.textContent = user.firstName;
                 memberBtn.className = `board-filter-btn px-3 py-1 rounded-full text-sm font-semibold transition-colors`;
                 boardFilterContainer.appendChild(memberBtn);
             });

             document.querySelectorAll('.board-filter-btn').forEach(btn => {
                 btn.classList.toggle('bg-blue-600', btn.dataset.filter === currentBoardFilter);
                 btn.classList.toggle('text-white', btn.dataset.filter === currentBoardFilter);
                 btn.classList.toggle('bg-gray-200', btn.dataset.filter !== currentBoardFilter);
                 btn.classList.toggle('text-gray-800', btn.dataset.filter !== currentBoardFilter);
             });
        };

        // --- DYNAMIC POST TYPE FIELDS ---
        const updatePostTypeFields = (type, details = {}) => {
            // This function is now empty as the feature is removed.
            const postTypeFieldsContainer = document.getElementById('post-type-fields');
            if(postTypeFieldsContainer) {
                postTypeFieldsContainer.innerHTML = '';
            }
        };


        // --- EVENT LISTENERS ---
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); render(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); render(); });
        
        const handleCloseAttempt = () => {
            if (savePostBtn.disabled) return;
            if (hasUnsavedChanges()) {
                openConfirmationModal({ title: 'Ungespeicherte Änderungen', message: 'Möchtest du das Fenster wirklich schliessen? Deine Änderungen gehen verloren.', confirmText: 'Schliessen', confirmClass: 'bg-red-600 hover:bg-red-700', onConfirm: closeModal });
            } else {
                closeModal();
            }
        };
        closeModalBtn.addEventListener('click', handleCloseAttempt);
        cancelModalBtn.addEventListener('click', handleCloseAttempt);
        
        savePostBtn.addEventListener('click', async () => {
            modalError.textContent = '';
            savePostBtn.disabled = true;
            savePostBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Speichern...`;

            try {
                const id = document.getElementById('postId').value;
                const postData = getFullFormState();
                postData.date = document.getElementById('postDate').value || null;
                postData.folderId = document.getElementById('postFolderId').value || 'unassigned';

                const user = auth.currentUser;
                if (!user) throw new Error("Benutzer nicht authentifiziert");

                if (id) {
                    await setDoc(doc(db, 'posts', id), postData, { merge: true });
                } else {
                    const docRef = await addDoc(collection(db, 'posts'), postData);
                    const newPostId = docRef.id;

                    if (localNewComments.length > 0) {
                        const batch = writeBatch(db);
                        localNewComments.forEach(comment => {
                            const commentRef = doc(collection(db, 'posts', newPostId, 'comments'));
                            const { createdAt, ...commentData } = comment;
                            batch.set(commentRef, { ...commentData, createdAt: serverTimestamp() });
                        });
                        await batch.commit();
                    }
                }
                
                closeModal();

            } catch (error) {
                console.error("Fehler beim Speichern:", error);
                modalError.textContent = "Fehler: Post konnte nicht gespeichert werden.";
            } finally {
                savePostBtn.disabled = false;
                savePostBtn.innerHTML = 'Speichern';
            }
        });

        deletePostBtn.addEventListener('click', () => {
            const id = document.getElementById('postId').value;
            if (id) {
                openConfirmationModal({
                    title: 'Post löschen',
                    message: 'Bist du sicher, dass du diesen Post endgültig löschen möchtest?',
                    confirmText: 'Löschen',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    onConfirm: async () => {
                        await deletePost(id);
                        closeModal();
                    }
                });
            }
        });
        
        confirmCancelBtn.addEventListener('click', closeConfirmationModal);
        confirmActionBtn.addEventListener('click', () => {
            if (typeof confirmAction === 'function') confirmAction();
            closeConfirmationModal();
        });
        
        addTaskBtn.addEventListener('click', () => {
            const text = newTaskInput.value.trim();
            if (text) { addTask(text); newTaskInput.value = ''; }
        });
        newTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTaskBtn.click(); });
        
        taskListContainer.addEventListener('click', (e) => { if (e.target.closest('.delete-task-btn')) e.target.closest('.task-item').remove(); });
        
        viewSwitcher.addEventListener('click', (e) => {
            const button = e.target.closest('.view-btn');
            if (button && button.dataset.view !== currentView) {
                currentView = button.dataset.view;
                render();
            }
        });

        boardFilterContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.board-filter-btn');
            if (button) {
                currentBoardFilter = button.dataset.filter;
                render();
            }
        });

        dashboardView.addEventListener('click', async (e) => {
            if (e.target.classList.contains('mark-mention-as-read-btn')) {
                const button = e.target;
                button.disabled = true;
                const postId = button.dataset.postId;
                const commentId = button.dataset.commentId;
                const user = auth.currentUser;

                if (!postId || !commentId || !user) return;

                const commentRef = doc(db, 'posts', postId, 'comments', commentId);
                const commentSnap = await getDoc(commentRef);

                if (commentSnap.exists()) {
                    const commentData = commentSnap.data();
                    const updatedMentions = commentData.mentions.map(mention => 
                        mention.uid === user.uid ? { ...mention, read: true } : mention
                    );
                    await updateDoc(commentRef, { mentions: updatedMentions });
                    renderDashboard(); // Re-render the dashboard to remove the item
                }
            }
        });


        addFolderBtn.addEventListener('click', () => openFolderModal());

        folderSaveBtn.addEventListener('click', async () => {
            const folderId = folderIdInput.value;
            const folderName = folderNameInput.value.trim();
            if (!folderName) return;

            if (folderId) {
                await updateFolder(folderId, folderName);
            } else {
                await createFolder(folderName);
            }
            closeFolderModal();
        });
        folderCancelBtn.addEventListener('click', closeFolderModal);

        ideaBankContainer.addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-idea-btn');
            const editBtn = e.target.closest('.edit-folder-btn');
            const deleteBtn = e.target.closest('.delete-folder-btn');

            if (addBtn) {
                const folderId = addBtn.dataset.folderId;
                resetModalForm();
                document.getElementById('postFolderId').value = folderId;
                openModal();
            } else if (editBtn) {
                const folderId = editBtn.dataset.folderId;
                const currentName = editBtn.dataset.folderName;
                openFolderModal(folderId, currentName);
            } else if (deleteBtn) {
                const folderId = deleteBtn.dataset.folderId;
                openConfirmationModal({
                    title: 'Ordner löschen',
                    message: 'Bist du sicher? Alle Ideen in diesem Ordner werden nach "Unsortiert" verschoben.',
                    confirmText: 'Löschen',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    onConfirm: () => deleteFolder(folderId)
                });
            }
        });

        profileBtn.addEventListener('click', openProfileModal);
        profileCancelBtn.addEventListener('click', closeProfileModal);
        profileSaveBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            profileSaveBtn.disabled = true;
            profileSaveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Speichern...`;

            try {
                const newFirstName = profileFirstNameInput.value.trim();
                const newLastName = profileLastNameInput.value.trim();
                
                if (!newFirstName || !newLastName) {
                    openConfirmationModal({ title: "Fehler", message: "Bitte Vor- und Nachname angeben.", confirmText: "OK", confirmClass: "bg-blue-600" });
                    profileSaveBtn.disabled = false;
                    profileSaveBtn.innerHTML = 'Speichern';
                    return;
                }

                const userDataToUpdate = {
                    firstName: newFirstName,
                    lastName: newLastName,
                };
                
                await setDoc(doc(db, "users", user.uid), userDataToUpdate, { merge: true });
                userGreetingEl.textContent = `Hallo, ${newFirstName}!`;
                
                closeProfileModal();
                openConfirmationModal({ title: "Erfolg", message: "Profil erfolgreich aktualisiert!", confirmText: "OK", confirmClass: "bg-blue-600" });
                
            } catch (error) {
                console.error("Fehler beim Speichern des Profils:", error);
                openConfirmationModal({ title: "Fehler", message: "Das Profil konnte nicht gespeichert werden.", confirmText: "OK", confirmClass: "bg-red-600" });
            } finally {
                profileSaveBtn.disabled = false;
                profileSaveBtn.innerHTML = 'Speichern';
            }
        });

        changePasswordBtn.addEventListener('click', () => {
            const newPassword = prompt("Bitte gib dein neues Passwort ein:");
            if (newPassword && newPassword.length >= 6) {
                updatePassword(auth.currentUser, newPassword).then(() => {
                    openConfirmationModal({ title: "Erfolg", message: "Passwort erfolgreich geändert!", confirmText: "OK", confirmClass: "bg-blue-600" });
                }).catch((error) => {
                    console.error("Fehler beim Ändern des Passworts:", error);
                    openConfirmationModal({ title: "Fehler", message: "Das Passwort konnte nicht geändert werden. Bitte logge dich erneut ein.", confirmText: "OK", confirmClass: "bg-red-600" });
                });
            } else if (newPassword) {
                openConfirmationModal({ title: "Fehler", message: "Das Passwort muss mindestens 6 Zeichen lang sein.", confirmText: "OK", confirmClass: "bg-red-600" });
            }
        });

        sendCommentBtn.addEventListener('click', async () => {
            const postId = document.getElementById('postId').value;
            let text = newCommentInput.value.trim();
            if (!text) return;

            sendCommentBtn.disabled = true;

            const mentionRegex = /@(\w+)/g;
            const mentions = [];
            let match;
            while ((match = mentionRegex.exec(text)) !== null) {
                const mentionedUser = allUsers.find(u => u.firstName === match[1]);
                if (mentionedUser) {
                    mentions.push({ uid: mentionedUser.id, read: false });
                }
            }
            
            const commentData = {
                text: text,
                authorId: auth.currentUser.uid,
                mentions: mentions
            };

            if (postId) {
                await saveComment(postId, commentData);
            } else {
                commentData.createdAt = new Date();
                localNewComments.push(commentData);
                renderComments(localNewComments);
            }
            
            newCommentInput.value = '';
            sendCommentBtn.disabled = false;
        });

        newCommentInput.addEventListener('input', () => {
            const text = newCommentInput.value;
            const mentionMatch = text.match(/@(\w*)$/);

            if (mentionMatch) {
                const searchTerm = mentionMatch[1].toLowerCase();
                const suggestions = allUsers.filter(u => u.firstName.toLowerCase().startsWith(searchTerm));
                
                if (suggestions.length > 0) {
                    mentionSuggestions.innerHTML = '';
                    suggestions.forEach(user => {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                        suggestionEl.textContent = user.firstName;
                        suggestionEl.onclick = () => {
                            const newText = text.replace(/@\w*$/, `@${user.firstName} `);
                            newCommentInput.value = newText;
                            mentionSuggestions.classList.add('hidden');
                            newCommentInput.focus();
                        };
                        mentionSuggestions.appendChild(suggestionEl);
                    });
                    mentionSuggestions.classList.remove('hidden');
                } else {
                    mentionSuggestions.classList.add('hidden');
                }
            } else {
                mentionSuggestions.classList.add('hidden');
            }
        });
        
        exportPdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const postData = getFullFormState();
            const postDate = document.getElementById('postDate').value;

            let y = 20; // Initial Y position
            const margin = 15;
            const maxWidth = doc.internal.pageSize.getWidth() - 2 * margin;

            // Header
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text(`Content Plan: ${postData.title || 'Unbenannter Post'}`, margin, y);
            y += 10;
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Geplant für: ${postDate || 'Noch nicht terminiert'}`, margin, y);
            y += 10;
            
            doc.setDrawColor(200);
            doc.line(margin, y, maxWidth + margin, y);
            y += 10;

            // --- Stammdaten ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Stammdaten", margin, y);
            y += 7;
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`Status: ${postData.status}`, margin, y);
            y += 10;

            doc.line(margin, y, maxWidth + margin, y);
            y += 10;

            // --- Caption ---
            doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Caption", margin, y); y += 7;
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(doc.splitTextToSize(postData.caption, maxWidth), margin, y);
            y += doc.getTextDimensions(doc.splitTextToSize(postData.caption, maxWidth)).h + 10;
            
            doc.line(margin, y, maxWidth + margin, y);
            y += 10;

            // --- Hashtags ---
            doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Hashtags", margin, y); y += 7;
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(postData.hashtags, margin, y);
            y += 15;

            // --- Footer ---
            doc.line(margin, doc.internal.pageSize.getHeight() - 20, maxWidth + margin, doc.internal.pageSize.getHeight() - 20);
            doc.setFontSize(8);
            doc.text(`Exportiert am ${new Date().toLocaleDateString('de-DE')} aus dem Onvitec Content Planer`, margin, doc.internal.pageSize.getHeight() - 10);


            doc.save(`Content-Plan_${postData.title.replace(/\s/g, '_')}.pdf`);
        });

        // --- INITIALIZATION ---
        updateAuthUI();

    </script>
</body>
</html>
